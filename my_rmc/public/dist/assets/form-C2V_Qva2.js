import{u as ye,n as _e,I as he,a as l,j as e,S as ge,B as _,C as te,R as K,y as se,z as ie,D as B,E as O,G as ae,H as w,Z as $,_ as xe}from"./index-f3r6umgb.js";import{u as Se,o as je}from"./index.esm-BMFR-kb1.js";import{S as Ne,D as Z}from"./SearchSelect-DAgorlIL.js";import{P as be}from"./Page-CZhRYwf3.js";import{a as ve,c as Oe,u as oe,d as we,b as re}from"./useApiHook-CZnV53As.js";import{F as Fe}from"./DocumentPlusIcon-y-FpWJLf.js";import{F as De}from"./PlusIcon-DQq1TcEG.js";import{z as ke,F as ce}from"./transition-Cc3pRxfh.js";import{y as qe,j as Ie}from"./popover-BlpAwzgS.js";import"./combobox-BXRS2Luv.js";import"./frozen-CEV0bN27.js";import"./active-element-history-HeLJeWOz.js";import"./Datepicker-Ma-0Q657.js";import"./index-CM3VLHP_.js";import"./iconBase-GIGs6mnI.js";import"./ConfirmModal-MqYg-eza.js";import"./XMarkIcon-Xa9uEXuI.js";import"./useUnmount-BWDo5Kza.js";import"./useMutation-BJYoKC_t.js";import"./floating-ui.dom-CtcSe9Ld.js";const ne="Delivery Challan List",P="Delivery Note",le=["posting_date","customer","custom_site","items"],me=["custom_dumppump","custom_asset_name","custom_vehicle","driver_name"],de={items:{item_code:!0,uom:!0,custom_bom_no:!0,qty:!0,custom_produced_qty:!0,custom_cumulative_qty:!0,against_sales_order:!0},ignorFields:{driver_name:!0}};function Ce({isOpen:R,onClose:J,onSelect:H,customer:u}){const[m,Q]=l.useState([]),[p,I]=l.useState(null),[U,E]=l.useState([]),[C,s]=l.useState({doctype:"Sales Order",page:1,page_length:10,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]]),fields:JSON.stringify(["name","customer","custom_site"])}),[M,r]=l.useState({doctype:"Sales Order Item",page:1,page_length:50,filters:JSON.stringify([["Sales Order Item","parent","=",""]]),fields:JSON.stringify(["name","item_code","qty","uom","rate","bom_no"])}),{data:j}=re(C),{data:N}=re(M);l.useEffect(()=>{s({...C,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]])})},[u]),l.useEffect(()=>{j!=null&&j.data&&Q(j.data)},[j]),l.useEffect(()=>{p&&r({...M,filters:JSON.stringify([["Sales Order Item","parent","=",p.name]])})},[p]),l.useEffect(()=>{N!=null&&N.data&&E(N.data)},[N]);const L=async o=>{I(o)},z=async(o,h)=>{const A=new Date().toISOString().split("T")[0],g=await $({doctype:"Delivery Note Item",page:1,page_length:1,fields:JSON.stringify(["*"]),filters:JSON.stringify([["Delivery Note Item","against_sales_order","=",o.name],["Delivery Note Item","so_detail","=",h.name],["Delivery Note Item","creation","Between",[A,A]]])});H(o,h,g?g==null?void 0:g.data[0]:null),I(null),E([]),J()};return e.jsx(ke,{appear:!0,show:R,as:K.Fragment,children:e.jsxs(qe,{as:"div",className:"fixed inset-0 z-100 flex flex-col items-center justify-center overflow-hidden px-4 py-6 sm:px-5",onClose:J,children:[e.jsx(ce,{as:K.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"absolute inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"})}),e.jsx(ce,{as:K.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsxs(Ie,{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col overflow-y-auto rounded-lg bg-white p-4 transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:p?"Select Item":"Select Sales Order"}),p&&e.jsx(_,{variant:"outlined",size:"sm",onClick:()=>I(null),children:"Back to Orders"})]}),p?e.jsxs(se,{children:[e.jsx(ie,{children:e.jsxs(B,{children:[e.jsx(O,{children:"Item Name"}),e.jsx(O,{children:"Quantity"}),e.jsx(O,{children:"UOM"}),e.jsx(O,{children:"Action"})]})}),e.jsx(ae,{children:U.map((o,h)=>e.jsxs(B,{children:[e.jsx(w,{children:o.item_code}),e.jsx(w,{children:o.qty}),e.jsx(w,{children:o.uom}),e.jsx(w,{children:e.jsx(_,{size:"sm",onClick:()=>z(p,o),children:"Select"})})]},h))})]}):e.jsxs(se,{children:[e.jsx(ie,{children:e.jsxs(B,{children:[e.jsx(O,{children:"Order No"}),e.jsx(O,{children:"Customer"}),e.jsx(O,{children:"Action"})]})}),e.jsx(ae,{children:m.map(o=>e.jsxs(B,{children:[e.jsx(w,{children:o.name}),e.jsx(w,{children:o.customer}),e.jsx(w,{children:e.jsx(_,{size:"sm",onClick:()=>L(o),children:"View Items"})})]},o.name))})]})]})})]})})}function Xe(){const{isDark:R,darkColorScheme:J,lightColorScheme:H}=ye(),u=_e(),{id:m}=he(),[Q,p]=l.useState(null),[I,U]=l.useState({}),[E,C]=l.useState(!1),{data:s,isFetching:M}=ve({doctype:P,fields:JSON.stringify([...le,...me])}),{data:r,isFetching:j}=Oe({doctype:P,id:m,fields:JSON.stringify(Q)});l.useEffect(()=>{if(s!=null&&s.fields){let t=s==null?void 0:s.fields.map(i=>i.fieldname);p(t),U(Object.fromEntries(t.map(i=>[i,""])))}},[s==null?void 0:s.fields]);const N=oe(t=>{t&&(t.docstatus===1?z(t):(Y(),u(-1)))}),L=we(async t=>{t&&(Y(),t.docstatus===1?z(t):u(-1))}),z=async t=>{let i="Installation Note";if((await $({doctype:i,filters:JSON.stringify([[i,"custom_delivery_note","=",t==null?void 0:t.name]]),fields:JSON.stringify(["name"])})).data[0])u(-1);else{let a={},c={},f=await xe({doctype:"BOM",id:t.items[0].custom_bom_no});if(t.posting_time){let S=new Date,[d,y,n]=t.posting_time.split(":").map(Number);S.setHours(d,y,n),S.setMinutes(S.getMinutes()-2);let k=S.toTimeString().split(" ")[0];a.inst_time=k}a.docstatus=1,a.custom_vehicle_no=t.custom_vehicle,a.custom_driver_name=t.driver,a.custom_recipe_name=t.items[0].item_code,a.customer=t.customer,a.custom_delivery_note=t.name;const T=new Date,fe=T.getFullYear()+"-"+String(T.getMonth()+1).padStart(2,"0")+"-"+String(T.getDate()).padStart(2,"0");a.inst_date=fe,c.item_code=t.items[0].item_code,c.qty=t.items[0].qty,c.custom_bom_no=t.items[0].custom_bom_no,c.custom_recipe_code=f?f.custom_recipe_code:"",c.custom_sales_order_no=t.items[0].against_sales_order;let G=t.items[0].qty,W=Number(G/1).toFixed(0);c.custom_count=W;let X=G/W;c.custom_percycle=X;let D=G/X;if(c.custom_no_of_batch=D,D){let S=D||1,d=new Date,[y,n,k]=a.inst_time.split(":").map(Number);d.setHours(y,n,k),d.setSeconds(d.getSeconds()-Number(S)*80);let v=d.toTimeString().split(" ")[0];a.custom_start_time=v}let ee=[];if(t.items[0].custom_bom_no){const S=f.items.length?f.items:[],d=await $({doctype:"Raw Material Mapping",fields:JSON.stringify(["item_name","item","decimal"]),order_by:"srno ASC"});for(let y=0;y<=d.data.length-1;y++){let n={},k={},v=S.find(q=>q.item_code==d.data[y].item&&!(q.item_code in k));if(n.item_name=d.data[y].item_name,n.decimal=d.data[y].decimal,v){k[v.item_code]=!0,n.qty=v.qty;const q=Array.from({length:D},()=>v.qty+Math.floor(Math.random()*12)-5);n.qtys=JSON.stringify(q),n.uom=v.uom}else{n.qty=0;const q=Array.from({length:D},()=>0);n.qtys=JSON.stringify(q),n.uom="Kg"}ee.push(n)}}o.mutate({doctype:i,body:{...a,items:[c],custom_installation_note_recipe:ee}})}},o=oe(t=>{t&&(Y(),u(-1))}),{register:h,handleSubmit:A,formState:{errors:g},control:V,reset:Y,setValue:x,watch:F}=Se({resolver:je(Ne(s==null?void 0:s.fields)),values:m?r:I}),ue=t=>{m?L.mutate({doctype:P,body:{...t,id:m}}):N.mutate({doctype:P,body:t})},pe=(t,i,b)=>{const a=new Date,c=a.getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");x("posting_date",c),x("custom_site",t==null?void 0:t.custom_site),x("custom_dumppump","Dumping");const f={item_name:i.item_code,item_code:i.item_code,custom_balance_quantity:i.qty,qty:0,uom:i.uom,custom_bom_no:i.bom_no,against_sales_order:t.name,so_detail:i.name,custom_cumulative_qty:(b==null?void 0:b.custom_cumulative_qty)||0};x("items",[f])};return M||j?e.jsx(ge,{style:{"--sk-color":R?J[700]:H[300]}}):e.jsxs(be,{title:(m?"Edit ":"New ")+ne,children:[e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Fe,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[m?"Edit":"New"," ",ne]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>u(-1),children:"Back"}),s!=null&&s.is_submittable?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",disabled:(r==null?void 0:r.docstatus)>1,onClick:()=>x("docstatus",0),children:"Save"}),(r==null?void 0:r.docstatus)===1?e.jsx(_,{className:"min-w-[7rem]",color:"error",type:"submit",form:"new-post-form",onClick:()=>x("docstatus",2),children:"Cancel"}):e.jsx(_,{className:"min-w-[7rem]",color:"success",type:"submit",form:"new-post-form",disabled:(r==null?void 0:r.docstatus)>1,onClick:()=>x("docstatus",1),children:"Submit"})]}):e.jsx(_,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",children:"Save"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:A(ue),id:"new-post-form",children:e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsx(te,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:!m&&!F("custom_site")?e.jsxs(e.Fragment,{children:[e.jsx(Z,{infos:s,fields:["customer"],register:h,control:V,errors:g}),F("customer")&&e.jsxs(_,{onClick:()=>C(!0),className:"flex items-center gap-2",children:[e.jsx(De,{className:"size-5"}),"Choose Products"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Z,{infos:s,fields:le,tables:de,register:h,control:V,errors:g,readOnly:!0}),!m&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"mb-2 block font-medium text-gray-700 dark:text-dark-50",children:"Enter Quantity"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsx("input",{type:"number",className:"form-input w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm+ dark:border-dark-500",placeholder:"Enter quantity",onChange:t=>{const i=parseFloat(t.target.value)||0,b=F("items")||[];if(b.length>0){const a=b.map(c=>{const f=c.custom_cumulative_qty||0,T=f+i;return{...c,qty:i,custom_produced_qty:f,custom_cumulative_qty:T,custom_serial_count:(c.custom_serial_count||0)+1}});x("items",a)}}})})]})]})})})}),(m||F("custom_site"))&&e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-4 lg:space-y-6",children:e.jsx(te,{className:"space-y-5 p-4 sm:px-5",children:e.jsx(Z,{infos:s,fields:me,tables:de,register:h,control:V,errors:g,readOnly:(s==null?void 0:s.is_submittable)&&(r==null?void 0:r.docstatus)})})})]})})]}),F("customer")&&e.jsx(Ce,{isOpen:E,onClose:()=>C(!1),onSelect:pe,customer:F("customer")})]})}export{Xe as default};
