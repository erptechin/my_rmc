import{a as l,u as le,n as re,I as ie,j as e,S as ce,B as R,C as ne,N as i,ai as P}from"./index-OVyVeGx_.js";import{u as de,o as oe,a as _,C as D}from"./index.esm-D6q5w4xC.js";import{S as me}from"./schema-jpqDMBo6.js";import{P as ue}from"./Page-CNGiw8W6.js";import{c as J,a as he,u as xe,d as ge}from"./useApiHook-DQNTkRy4.js";import{F as pe}from"./DocumentPlusIcon-CO1uob1A.js";import"./useUnmount-BMOfKNk-.js";import"./useMutation-W2OWZE4e.js";const fe=(w,W,I)=>{const[S,a]=l.useState(!1),[O,f]=l.useState(!0),[n,N]=l.useState(!0),[M,j]=l.useState(!1),[t,Q]=l.useState([]),[q,o]=l.useState(!w),[u,c]=l.useState(""),[T,b]=l.useState(!1),[v,E]=l.useState(null),{data:h}=J({doctype:"RMC Settings",id:"enable_weigh_scale",fields:JSON.stringify(["enable_weigh_scale","baud_rate","split_character"])}),{data:B}=J({doctype:"Purchase Order",id:W,fields:JSON.stringify(["supplier_name"]),enabled:!!W}),{data:z}=J({doctype:"Delivery Note",id:I,fields:JSON.stringify(["customer","custom_vehicle"]),enabled:!!I}),C=async(s,g)=>{const d=new TextDecoderStream;s.readable.pipeTo(d.writable);const m=d.readable.getReader();let p=0;for(;;)try{const{value:x,done:F}=await m.read();if(F){m.releaseLock();break}let y=String(x).includes(g.split_character)?String(x).replace(g.split_character,""):String(x);p!==Number(y)&&(p=Number(y),c(String(Number(y))))}catch(x){console.error("Error reading from serial port:",x);break}};return l.useEffect(()=>{let s=null;return(async()=>{if(b(!0),"serial"in navigator&&h)try{const d=await navigator.serial.getPorts();if(d.length===0){const m=await navigator.serial.requestPort();await m.open({baudRate:Number(h.baud_rate)}),E(m),await C(m,h)}else await d[0].open({baudRate:Number(h.message.baud_rate)}),E(d[0]),await C(d[0],h)}catch(d){console.log("Serial port connection failed, using test mode:",d)}else console.log("Browser does not support serial device connection")})(),()=>{}},[w,h]),l.useEffect(()=>()=>{if(v)try{v.close()}catch(s){console.error("Error closing serial port:",s)}},[v]),{isGrossDisabled:S,isTareDisabled:O,showInward:n,showOutward:M,itemOptions:t,isNewRecord:q,displayData:u,isWeighScaleEnabled:T,serialPort:v,rmcSettings:h,purchaseOrderData:B,deliveryNoteData:z,handleWBSlipTypeChange:s=>{s?s==="Inward"?(N(!0),j(!1),a(!1),f(!0)):s==="Outward"?(N(!1),j(!0),a(!0),f(!1)):s==="Other"&&(N(!0),j(!0),a(!1),f(!1)):(N(!0),j(!1),a(!1),f(!0))},handleGrossWeight:s=>{u&&(s("gross_weight",u),s("gross_weight_date_time",new Date().toISOString().slice(0,19).replace("T"," ")),a(!0))},handleTareWeight:s=>{u&&(s("tare_weight",u),s("tare_weight_date_time",new Date().toISOString().slice(0,19).replace("T"," ")),f(!0))},calculateWeight:(s,g,d,m)=>{if(s&&g){const p=parseFloat(s)-parseFloat(g);m("net_weight",p.toString());const x=(parseFloat(d)||0)/100*p;m("grand_net_weight",(p-x).toString())}},setItemOptions:Q,setIsGrossDisabled:a,setIsTareDisabled:f,setShowInward:N,setShowOutward:j}},ee="Weight Bridge",A="Weight Bridge",K=["date","display_data","wbslip_type","company","purchase_order","supplier_name","vehicle_no","transporter","ref_no","delivery_note","customer_name","vehicle","item","deduct_reason","gross_weight_date_time","tare_weight_date_time","gross_weight","tare_weight","net_weight","deduct","grand_net_weight"],U=["gross","tare"],$=Object.fromEntries([...K,...U].map(w=>[w,""]));$.wbslip_type="Inward";$.date=new Date().toISOString().split("T")[0];function Oe(){const{isDark:w,darkColorScheme:W,lightColorScheme:I}=le(),S=re(),{id:a}=ie(),{data:O,isFetching:f}=he({doctype:A,fields:JSON.stringify([...K,...U])}),{data:n,isFetching:N}=J({doctype:A,id:a,fields:JSON.stringify([...K,...U])}),M=xe(r=>{r&&(u(),S(-1))}),j=ge(r=>{r&&(u(),S(-1))}),{register:t,handleSubmit:Q,formState:{errors:q},control:o,reset:u,setValue:c,watch:T}=de({resolver:oe(me(O==null?void 0:O.fields)),defaultValues:a?n:$});l.useEffect(()=>{n&&a&&u(n)},[n,a,u]);const b=_({control:o,name:"wbslip_type"}),v=_({control:o,name:"purchase_order"}),E=_({control:o,name:"delivery_note"}),{isGrossDisabled:h,isTareDisabled:B,showInward:z,showOutward:C,itemOptions:V,displayData:L,isWeighScaleEnabled:H,purchaseOrderData:k,deliveryNoteData:s,handleWBSlipTypeChange:g,handleGrossWeight:d,handleTareWeight:m,calculateWeight:p,setIsGrossDisabled:x,setIsTareDisabled:F,setShowInward:y,setShowOutward:G}=fe(a,v,E);l.useEffect(()=>{n&&a&&(n.gross_weight&&x(!0),n.tare_weight&&F(!0),n.wbslip_type==="Inward"?(y(!0),G(!1)):n.wbslip_type==="Outward"?(y(!1),G(!0)):n.wbslip_type==="Other"&&(y(!0),G(!0)))},[n,a,x,F,y,G]);const X=_({control:o,name:"gross_weight"}),Y=_({control:o,name:"tare_weight"}),Z=_({control:o,name:"deduct"});l.useEffect(()=>{p(X,Y,Z,c)},[X,Y,Z,c,p]),l.useEffect(()=>{g(b)},[b,g]),l.useEffect(()=>{a||(b||c("wbslip_type","Inward"),T("date")||c("date",new Date().toISOString().split("T")[0]))},[a,b,c,T]);const se=()=>{d(c)},ae=()=>{m(c)};l.useEffect(()=>{k&&c("supplier_name",k.supplier_name)},[k,c]),l.useEffect(()=>{s&&(c("customer_name",s.customer),c("vehicle",s.custom_vehicle))},[s,c]);const te=r=>{a?j.mutate({doctype:A,body:{...r,id:a}}):M.mutate({doctype:A,body:r})};return f||N?e.jsx(ce,{style:{"--sk-color":w?W[700]:I[300]}}):e.jsx(ue,{title:(a?"Edit ":"New ")+ee,children:e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[a?"Edit":"New"," ",ee]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>S(-1),children:"Back"}),e.jsx(R,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",children:"Save"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:Q(te),id:"new-post-form",children:e.jsxs(ne,{className:"p-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Date"}),e.jsx(i,{...t("date"),type:"date",className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Display Data"}),e.jsxs("div",{className:"relative",children:[e.jsx(i,{value:L,className:"w-full bg-purple-50 text-center text-lg font-mono font-bold",placeholder:"",readOnly:!0}),H&&e.jsx("div",{className:"absolute right-2 top-1/2 transform -translate-y-1/2",children:e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"WBSlip Type"}),e.jsx(D,{name:"wbslip_type",control:o,render:({field:r})=>(console.log("WBSlip Type field:",r),e.jsxs("select",{...r,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"Select Type"}),e.jsx("option",{value:"Inward",children:"Inward"}),e.jsx("option",{value:"Outward",children:"Outward"}),e.jsx("option",{value:"Other",children:"Other"})]}))})]})]}),z&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Inward"}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Purchase Order"}),e.jsx(i,{...t("purchase_order"),className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Supplier Name"}),e.jsx(i,{...t("supplier_name"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Vehicle No"}),e.jsx(i,{...t("vehicle_no"),className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Transporter"}),e.jsx(i,{...t("transporter"),className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Ref No"}),e.jsx(i,{...t("ref_no"),className:"w-full",placeholder:""})]})]})]}),C&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4",children:"Outward"}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Delivery Note"}),e.jsx(i,{...t("delivery_note"),className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Customer Name"}),e.jsx(i,{...t("customer_name"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Vehicle"}),e.jsx(i,{...t("vehicle"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Item"}),e.jsx(D,{name:"item",control:o,render:({field:r})=>e.jsx(P,{...r,className:"w-full",options:V,placeholder:"Select Item"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Deduct Reason"}),e.jsx(D,{name:"deduct_reason",control:o,render:({field:r})=>e.jsx(P,{...r,className:"w-full",options:[{label:"Select",value:""},{label:"Moisture",value:"Moisture"},{label:"Bad Quality",value:"Bad Quality"}],placeholder:"Select"})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Item"}),e.jsx(D,{name:"item",control:o,render:({field:r})=>e.jsx(P,{...r,className:"w-full",options:V,placeholder:"Select Item"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Gross Weight Date Time"}),e.jsx(i,{...t("gross_weight_date_time"),type:"datetime-local",className:"w-full",placeholder:"",readOnly:!0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Asia/Kolkata"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Gross Weight"}),e.jsx(i,{...t("gross_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Deduct %"}),e.jsx(i,{...t("deduct"),type:"number",step:"0.01",className:"w-full",placeholder:""})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:" "}),e.jsx(R,{type:"button",onClick:se,disabled:h,className:`w-full ${h?"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed":"bg-green-100 text-green-700 border-green-300 hover:bg-green-200"}`,variant:"outlined",children:"Gross"})]})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Deduct Reason"}),e.jsx(D,{name:"deduct_reason",control:o,render:({field:r})=>e.jsx(P,{...r,className:"w-full",options:[{label:"Select",value:""},{label:"Moisture",value:"Moisture"},{label:"Bad Quality",value:"Bad Quality"}],placeholder:"Select"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Tare Weight Date Time"}),e.jsx(i,{...t("tare_weight_date_time"),type:"datetime-local",className:"w-full",placeholder:"",readOnly:!0}),e.jsx("p",{className:"text-xs text-gray-500",children:"Asia/Kolkata"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Tare Weight"}),e.jsx(i,{...t("tare_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Grand Net Weight"}),e.jsx(i,{...t("grand_net_weight"),className:"w-full",placeholder:"",readOnly:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:" "}),e.jsx(R,{type:"button",onClick:ae,disabled:B,className:`w-full ${B?"bg-gray-100 text-gray-400 border-gray-200 cursor-not-allowed":"border-dashed border-gray-300 text-gray-600 hover:bg-gray-50"}`,variant:"outlined",children:"Tare"})]})]}),e.jsx("div",{className:"grid grid-cols-5 gap-4",children:e.jsxs("div",{className:"col-span-2 col-start-3 space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Net Weight"}),e.jsx(i,{...t("net_weight"),className:"w-full",placeholder:"",readOnly:!0})]})})]})]})})]})})}export{Oe as default};
