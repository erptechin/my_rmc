import{u as _e,n as fe,I as ye,a as n,j as e,S as ge,B as k,C as ee,R as G,y as te,z as se,D as A,E as b,G as ie,H as N,Y as Z,Z as he}from"./index-BcgC7bEx.js";import{u as xe,o as Se}from"./index.esm-BmcmwKHn.js";import{S as je,D as K}from"./dynamicForms-h6Q_OMJM.js";import{P as be}from"./Page-BXV_CSDQ.js";import{a as Ne,c as ve,u as ae,d as Oe,b as re}from"./useApiHook-DRp2Rmqp.js";import{F as we}from"./DocumentPlusIcon-DOj4uTSw.js";import{F as Fe}from"./PlusIcon-CI-fa0zq.js";import{z as De,a0 as oe}from"./transition-BN78bud4.js";import{y as qe,j as ke}from"./dialog-DLA48HIf.js";import"./ConfirmModal-n7XvdN-B.js";import"./Datepicker-D7XZxa7_.js";import"./combobox-C_DE3f7-.js";import"./frozen-CNDjlDe-.js";import"./active-element-history-DwKsPabT.js";import"./index-Bk7ixeF0.js";import"./iconBase-DjODM-Em.js";import"./useUnmount-BOXyjZUX.js";import"./useMutation-BEPNfLcm.js";import"./floating-ui.dom-CtcSe9Ld.js";const ce="Delivery Challan List",B="Delivery Note",ne=["posting_date","customer","custom_site","items"],le=["custom_dumppump","custom_asset_name","custom_vehicle","driver_name"],me={items:{item_code:!0,uom:!0,custom_bom_no:!0,qty:!0,custom_produced_qty:!0,custom_cumulative_qty:!0,against_sales_order:!0},ignorFields:{driver_name:!0}};function Ie({isOpen:P,onClose:E,onSelect:R,customer:u}){const[m,H]=n.useState([]),[p,I]=n.useState(null),[Q,M]=n.useState([]),[C,s]=n.useState({doctype:"Sales Order",page:1,page_length:10,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]]),fields:JSON.stringify(["name","customer","custom_site"])}),[z,l]=n.useState({doctype:"Sales Order Item",page:1,page_length:50,filters:JSON.stringify([["Sales Order Item","parent","=",""]]),fields:JSON.stringify(["name","item_code","qty","uom","rate","bom_no"])}),{data:h}=re(C),{data:x}=re(z);n.useEffect(()=>{s({...C,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]])})},[u]),n.useEffect(()=>{h!=null&&h.data&&H(h.data)},[h]),n.useEffect(()=>{p&&l({...z,filters:JSON.stringify([["Sales Order Item","parent","=",p.name]])})},[p]),n.useEffect(()=>{x!=null&&x.data&&M(x.data)},[x]);const U=async i=>{I(i)},Y=async(i,v)=>{const O=new Date().toISOString().split("T")[0],y=await Z({doctype:"Delivery Note Item",page:1,page_length:1,fields:JSON.stringify(["*"]),filters:JSON.stringify([["Delivery Note Item","against_sales_order","=",i.name],["Delivery Note Item","so_detail","=",v.name],["Delivery Note Item","creation","Between",[O,O]]])});R(i,v,y?y==null?void 0:y.data[0]:null),I(null),M([]),E()};return e.jsx(De,{appear:!0,show:P,as:G.Fragment,children:e.jsxs(qe,{as:"div",className:"fixed inset-0 z-100 flex flex-col items-center justify-center overflow-hidden px-4 py-6 sm:px-5",onClose:E,children:[e.jsx(oe,{as:G.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"absolute inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"})}),e.jsx(oe,{as:G.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsxs(ke,{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col overflow-y-auto rounded-lg bg-white p-4 transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:p?"Select Item":"Select Sales Order"}),p&&e.jsx(k,{variant:"outlined",size:"sm",onClick:()=>I(null),children:"Back to Orders"})]}),p?e.jsxs(te,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(b,{children:"Item Name"}),e.jsx(b,{children:"Quantity"}),e.jsx(b,{children:"UOM"}),e.jsx(b,{children:"Action"})]})}),e.jsx(ie,{children:Q.map((i,v)=>e.jsxs(A,{children:[e.jsx(N,{children:i.item_code}),e.jsx(N,{children:i.qty}),e.jsx(N,{children:i.uom}),e.jsx(N,{children:e.jsx(k,{size:"sm",onClick:()=>Y(p,i),children:"Select"})})]},v))})]}):e.jsxs(te,{children:[e.jsx(se,{children:e.jsxs(A,{children:[e.jsx(b,{children:"Order No"}),e.jsx(b,{children:"Customer"}),e.jsx(b,{children:"Action"})]})}),e.jsx(ie,{children:m.map(i=>e.jsxs(A,{children:[e.jsx(N,{children:i.name}),e.jsx(N,{children:i.customer}),e.jsx(N,{children:e.jsx(k,{size:"sm",onClick:()=>U(i),children:"View Items"})})]},i.name))})]})]})})]})})}function $e(){const{isDark:P,darkColorScheme:E,lightColorScheme:R}=_e(),u=fe(),{id:m}=ye(),[H,p]=n.useState(null),[I,Q]=n.useState({}),[M,C]=n.useState(!1),{data:s,isFetching:z}=Ne({doctype:B,fields:JSON.stringify([...ne,...le])}),{data:l,isFetching:h}=ve({doctype:B,id:m,fields:JSON.stringify(H)});n.useEffect(()=>{if(s!=null&&s.fields){let t=s==null?void 0:s.fields.map(a=>a.fieldname);p(t),Q(Object.fromEntries(t.map(a=>[a,""])))}},[s==null?void 0:s.fields]);const x=ae(t=>{t&&(L(),u(-1))}),U=ae(t=>{t&&(L(),u(-1))}),Y=Oe(async t=>{if(t)if(L(),t.docstatus){let a="Installation Note";if((await Z({doctype:a,filters:JSON.stringify([[a,"custom_delivery_note","=",t==null?void 0:t.name]]),fields:JSON.stringify(["name"])})).data[0])u(-1);else{let r={},o={},_=await he({doctype:"BOM",id:t.items[0].custom_bom_no});if(t.posting_time){let g=new Date,[d,f,c]=t.posting_time.split(":").map(Number);g.setHours(d,f,c),g.setMinutes(g.getMinutes()-2);let D=g.toTimeString().split(" ")[0];r.inst_time=D}r.docstatus=1,r.custom_vehicle_no=t.custom_vehicle,r.custom_driver_name=t.driver,r.custom_recipe_name=t.items[0].item_code,r.customer=t.customer,r.custom_delivery_note=t.name;const J=new Date,pe=J.getFullYear()+"-"+String(J.getMonth()+1).padStart(2,"0")+"-"+String(J.getDate()).padStart(2,"0");r.inst_date=pe,o.item_code=t.items[0].item_code,o.qty=t.items[0].qty,o.custom_bom_no=t.items[0].custom_bom_no,o.custom_recipe_code=_?_.custom_recipe_code:"",o.custom_sales_order_no=t.items[0].against_sales_order;let V=t.items[0].qty,$=Number(V/1).toFixed(0);o.custom_count=$;let W=V/$;o.custom_percycle=W;let F=V/W;if(o.custom_no_of_batch=F,F){let g=F||1,d=new Date,[f,c,D]=r.inst_time.split(":").map(Number);d.setHours(f,c,D),d.setSeconds(d.getSeconds()-Number(g)*80);let j=d.toTimeString().split(" ")[0];r.custom_start_time=j}let X=[];if(t.items[0].custom_bom_no){const g=_.custom_items_2.length?_.custom_items_2:[],d=await Z({doctype:"Raw Material Mapping",fields:JSON.stringify(["item_name","item","decimal"]),order_by:"srno ASC"});for(let f=0;f<=d.data.length-1;f++){let c={},D={},j=g.find(q=>q.item_code==d.data[f].item&&!(q.item_code in D));if(c.item_name=d.data[f].item_name,c.decimal=d.data[f].decimal,j){D[j.item_code]=!0,c.qty=j.qty;const q=Array.from({length:F},()=>j.qty+Math.floor(Math.random()*12)-5);c.qtys=JSON.stringify(q),c.uom=j.uom}else{c.qty=0;const q=Array.from({length:F},()=>0);c.qtys=JSON.stringify(q),c.uom="Kg"}X.push(c)}}U.mutate({doctype:a,body:{...r,items:[o],custom_installation_note_recipe:X}})}}else u(-1)}),{register:i,handleSubmit:v,formState:{errors:O},control:y,reset:L,setValue:T,watch:w}=xe({resolver:Se(je(s==null?void 0:s.fields)),values:m?l:I}),de=t=>{m?((t==null?void 0:t.status)==="Draft"&&(s!=null&&s.is_submittable)&&(t.docstatus=1),Y.mutate({doctype:B,body:{...t,id:m}})):x.mutate({doctype:B,body:t})},ue=(t,a,S)=>{const r=new Date,o=r.getFullYear()+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0");T("posting_date",o),T("custom_site",t==null?void 0:t.custom_site),T("custom_dumppump","Dumping");const _={item_name:a.item_code,item_code:a.item_code,custom_balance_quantity:a.qty,qty:0,uom:a.uom,custom_bom_no:a.bom_no,against_sales_order:t.name,so_detail:a.name,custom_cumulative_qty:(S==null?void 0:S.custom_cumulative_qty)||0};T("items",[_])};return z||h?e.jsx(ge,{style:{"--sk-color":P?E[700]:R[300]}}):e.jsxs(be,{title:(m?"Edit ":"New ")+ce,children:[e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(we,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[m?"Edit":"New"," ",ce]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>u(-1),children:"Back"}),e.jsx(k,{className:"min-w-[7rem]",color:(l==null?void 0:l.status)==="Draft"&&(s!=null&&s.is_submittable)?"success":"primary",type:"submit",form:"new-post-form",children:(l==null?void 0:l.status)==="Draft"&&(s!=null&&s.is_submittable)?"Submit":"Save"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:v(de),id:"new-post-form",children:e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsx(ee,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:!m&&!w("custom_site")?e.jsxs(e.Fragment,{children:[e.jsx(K,{infos:s,fields:["customer"],register:i,control:y,errors:O}),w("customer")&&e.jsxs(k,{onClick:()=>C(!0),className:"flex items-center gap-2",children:[e.jsx(Fe,{className:"size-5"}),"Choose Products"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(K,{infos:s,fields:ne,tables:me,register:i,control:y,errors:O,readOnly:!0}),!m&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"mb-2 block font-medium text-gray-700 dark:text-dark-50",children:"Enter Quantity"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsx("input",{type:"number",className:"form-input w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm+ dark:border-dark-500",placeholder:"Enter quantity",onChange:t=>{const a=parseFloat(t.target.value)||0,S=w("items")||[];if(S.length>0){const r=S.map(o=>{const _=o.custom_cumulative_qty||0,J=_+a;return{...o,qty:a,custom_produced_qty:_,custom_cumulative_qty:J,custom_serial_count:(o.custom_serial_count||0)+1}});T("items",r)}}})})]})]})})})}),(m||w("custom_site"))&&e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-4 lg:space-y-6",children:e.jsx(ee,{className:"space-y-5 p-4 sm:px-5",children:e.jsx(K,{infos:s,fields:le,tables:me,register:i,control:y,errors:O,readOnly:(s==null?void 0:s.is_submittable)&&(l==null?void 0:l.docstatus)})})})]})})]}),w("customer")&&e.jsx(Ie,{isOpen:M,onClose:()=>C(!1),onSelect:ue,customer:w("customer")})]})}export{$e as default};
