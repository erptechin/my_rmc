import{u as he,n as xe,I as Se,a as c,j as e,S as je,B as D,C as ie,J as ae,R as W,y as oe,z as re,D as R,E as N,G as ne,H as b,Z as $,_ as Ne}from"./index-tezJWvRu.js";import{u as be,o as ve}from"./index.esm-BpxEn2Xf.js";import{S as Oe,D as X}from"./SearchSelect-BynzNCzB.js";import{P as we}from"./Page-DkJTNvhQ.js";import{a as Fe,c as qe,u as ce,d as ke,b as le}from"./useApiHook-DAVQaeGF.js";import{F as De}from"./DocumentPlusIcon-D0xxrYjC.js";import{F as Ie}from"./PlusIcon-BEAxZBfb.js";import{z as Je,F as me}from"./transition-BGQrIAVB.js";import{y as Ce,j as Te}from"./popover-DLbrr7wn.js";import"./combobox-B87ZL816.js";import"./frozen-CydSP9IF.js";import"./active-element-history-Da40JTmH.js";import"./Datepicker-JND9Igds.js";import"./index-DacI4ZKE.js";import"./iconBase-ZocHpk2Z.js";import"./ConfirmModal--_fTrmvP.js";import"./XMarkIcon-DXmj_b8h.js";import"./useUnmount-BAxa_kbC.js";import"./useMutation-DprROyh2.js";import"./floating-ui.dom-CtcSe9Ld.js";const de="Delivery Challan List",T="Delivery Note",ue=["posting_date","customer","custom_site","items"],pe=["custom_dumppump","custom_asset_name","custom_vehicle","driver_name"],fe={items:{item_code:!0,uom:!0,custom_bom_no:!0,qty:!0,custom_produced_qty:!0,custom_cumulative_qty:!0,against_sales_order:!0},ignorFields:{driver_name:!0}};function Ee({isOpen:H,onClose:E,onSelect:Q,customer:u}){const[l,U]=c.useState([]),[p,I]=c.useState(null),[L,M]=c.useState([]),[J,i]=c.useState({doctype:"Sales Order",page:1,page_length:10,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]]),fields:JSON.stringify(["name","customer","custom_site"])}),[z,v]=c.useState({doctype:"Sales Order Item",page:1,page_length:50,filters:JSON.stringify([["Sales Order Item","parent","=",""]]),fields:JSON.stringify(["name","item_code","qty","uom","rate","bom_no"])}),{data:x}=le(J),{data:S}=le(z);c.useEffect(()=>{i({...J,filters:JSON.stringify([["Sales Order","status","!=","Draft"],["Sales Order","customer","=",u]])})},[u]),c.useEffect(()=>{x!=null&&x.data&&U(x.data)},[x]),c.useEffect(()=>{p&&v({...z,filters:JSON.stringify([["Sales Order Item","parent","=",p.name]])})},[p]),c.useEffect(()=>{S!=null&&S.data&&M(S.data)},[S]);const V=async o=>{I(o)},A=async(o,y)=>{const B=new Date().toISOString().split("T")[0],_=await $({doctype:"Delivery Note Item",page:1,page_length:1,fields:JSON.stringify(["*"]),filters:JSON.stringify([["Delivery Note Item","against_sales_order","=",o.name],["Delivery Note Item","so_detail","=",y.name],["Delivery Note Item","creation","Between",[B,B]]])});Q(o,y,_?_==null?void 0:_.data[0]:null),I(null),M([]),E()};return e.jsx(Je,{appear:!0,show:H,as:W.Fragment,children:e.jsxs(Ce,{as:"div",className:"fixed inset-0 z-100 flex flex-col items-center justify-center overflow-hidden px-4 py-6 sm:px-5",onClose:E,children:[e.jsx(me,{as:W.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsx("div",{className:"absolute inset-0 bg-gray-900/50 transition-opacity dark:bg-black/40"})}),e.jsx(me,{as:W.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e.jsxs(Te,{className:"scrollbar-sm relative flex w-full max-w-2xl flex-col overflow-y-auto rounded-lg bg-white p-4 transition-opacity duration-300 dark:bg-dark-700",children:[e.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-gray-100",children:p?"Select Item":"Select Sales Order"}),p&&e.jsx(D,{variant:"outlined",size:"sm",onClick:()=>I(null),children:"Back to Orders"})]}),p?e.jsxs(oe,{children:[e.jsx(re,{children:e.jsxs(R,{children:[e.jsx(N,{children:"Item Name"}),e.jsx(N,{children:"Quantity"}),e.jsx(N,{children:"UOM"}),e.jsx(N,{children:"Action"})]})}),e.jsx(ne,{children:L.map((o,y)=>e.jsxs(R,{children:[e.jsx(b,{children:o.item_code}),e.jsx(b,{children:o.qty}),e.jsx(b,{children:o.uom}),e.jsx(b,{children:e.jsx(D,{size:"sm",onClick:()=>A(p,o),children:"Select"})})]},y))})]}):e.jsxs(oe,{children:[e.jsx(re,{children:e.jsxs(R,{children:[e.jsx(N,{children:"Order No"}),e.jsx(N,{children:"Customer"}),e.jsx(N,{children:"Action"})]})}),e.jsx(ne,{children:l.map(o=>e.jsxs(R,{children:[e.jsx(b,{children:o.name}),e.jsx(b,{children:o.customer}),e.jsx(b,{children:e.jsx(D,{size:"sm",onClick:()=>V(o),children:"View Items"})})]},o.name))})]})]})})]})})}function st(){const{isDark:H,darkColorScheme:E,lightColorScheme:Q}=he(),u=xe(),{id:l}=Se(),[U,p]=c.useState(null),[I,L]=c.useState({}),[M,J]=c.useState(!1),{data:i,isFetching:z}=Fe({doctype:T,fields:JSON.stringify([...ue,...pe])}),{data:v,isFetching:x}=qe({doctype:T,id:l,fields:JSON.stringify(U)});c.useEffect(()=>{if(i!=null&&i.fields){let t=i==null?void 0:i.fields.map(s=>s.fieldname);p(t),L(Object.fromEntries(t.map(s=>[s,""])))}},[i==null?void 0:i.fields]);const S=ce(t=>{t&&(G(),t.docstatus===1?A(t):u(-1))}),V=ke(async t=>{t&&(G(),t.docstatus===1?A(t):u(-1))}),A=async t=>{var g;let s="Installation Note",r=await $({doctype:s,filters:JSON.stringify([[s,"custom_delivery_note","=",t==null?void 0:t.name]]),fields:JSON.stringify(["name"]),page_length:1e3});if(((g=r==null?void 0:r.data)==null?void 0:g.length)>0&&await ae({url:`my_rmc.api.doctype.delete_data?doctype=${s}&ids=${JSON.stringify(r==null?void 0:r.data.map(a=>a.name))}`}),(await $({doctype:s,filters:JSON.stringify([[s,"custom_delivery_note","=",t==null?void 0:t.name]]),fields:JSON.stringify(["name"])})).data[0])u(-1);else{let a={},m={},P=await Ne({doctype:"BOM",id:t.items[0].custom_bom_no});if(t.posting_time){let h=new Date,[d,f,n]=t.posting_time.split(":").map(Number);h.setHours(d,f,n),h.setMinutes(h.getMinutes()-2);let q=h.toTimeString().split(" ")[0];a.inst_time=q}a.docstatus=1,a.custom_vehicle_no=t.custom_vehicle,a.custom_driver_name=t.driver,a.custom_recipe_name=t.items[0].item_code,a.customer=t.customer,a.custom_delivery_note=t.name;const K=new Date,ge=K.getFullYear()+"-"+String(K.getMonth()+1).padStart(2,"0")+"-"+String(K.getDate()).padStart(2,"0");a.inst_date=ge,m.item_code=t.items[0].item_code,m.qty=t.items[0].qty,m.custom_bom_no=t.items[0].custom_bom_no,m.custom_recipe_code=P?P.custom_recipe_code:"",m.custom_sales_order_no=t.items[0].against_sales_order;let Z=t.items[0].qty,ee=Number(Z/1).toFixed(0);m.custom_count=ee;let te=Z/ee;m.custom_percycle=te;let F=Z/te;if(m.custom_no_of_batch=F,F){let h=F||1,d=new Date,[f,n,q]=a.inst_time.split(":").map(Number);d.setHours(f,n,q),d.setSeconds(d.getSeconds()-Number(h)*80);let j=d.toTimeString().split(" ")[0];a.custom_start_time=j}let se=[];if(t.items[0].custom_bom_no){const h=P.items.length?P.items:[],d=await $({doctype:"Raw Material Mapping",fields:JSON.stringify(["item_name","item","decimal"]),order_by:"srno ASC"});for(let f=0;f<=d.data.length-1;f++){let n={},q={},j=h.find(k=>k.item_code==d.data[f].item&&!(k.item_code in q));if(n.item_name=d.data[f].item_name,n.decimal=d.data[f].decimal,j){q[j.item_code]=!0,n.qty=j.qty;const k=Array.from({length:F},()=>j.qty+Math.floor(Math.random()*12)-5);n.qtys=JSON.stringify(k),n.uom=j.uom}else{n.qty=0;const k=Array.from({length:F},()=>0);n.qtys=JSON.stringify(k),n.uom="Kg"}se.push(n)}}o.mutate({doctype:s,body:{...a,items:[m],custom_installation_note_recipe:se}})}},o=ce(t=>{t&&(G(),u(-1))}),{register:y,handleSubmit:B,formState:{errors:_},control:Y,reset:G,setValue:C,watch:O}=be({resolver:ve(Oe(i==null?void 0:i.fields)),values:l?v:I}),ye=async t=>{l?(await ae({url:`my_rmc.api.doctype.update_data?doctype=${T}&name=${l}&update_fields=${JSON.stringify([{docstatus:0}])}`})).success&&(delete t.creation,delete t.modified,V.mutate({doctype:T,body:{...t,docstatus:1,id:l}})):S.mutate({doctype:T,body:{...t,docstatus:1}})},_e=(t,s,r)=>{const w=new Date,g=w.getFullYear()+"-"+String(w.getMonth()+1).padStart(2,"0")+"-"+String(w.getDate()).padStart(2,"0");C("posting_date",g),C("custom_site",t==null?void 0:t.custom_site),C("custom_dumppump","Dumping");const a={item_name:s.item_code,item_code:s.item_code,custom_balance_quantity:s.qty,qty:0,uom:s.uom,custom_bom_no:s.bom_no,against_sales_order:t.name,so_detail:s.name,custom_cumulative_qty:(r==null?void 0:r.custom_cumulative_qty)||0};C("items",[a])};return z||x?e.jsx(je,{style:{"--sk-color":H?E[700]:Q[300]}}):e.jsxs(we,{title:(l?"Edit ":"New ")+de,children:[e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(De,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[l?"Edit":"New"," ",de]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>u(-1),children:"Back"}),e.jsx(D,{className:"min-w-[7rem]",color:"success",type:"submit",form:"new-post-form",children:"Submit"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:B(ye),id:"new-post-form",children:e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsx(ie,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:!l&&!O("custom_site")?e.jsxs(e.Fragment,{children:[e.jsx(X,{infos:i,fields:["customer"],register:y,control:Y,errors:_}),O("customer")&&e.jsxs(D,{onClick:()=>J(!0),className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"size-5"}),"Choose Products"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{infos:i,fields:ue,tables:fe,register:y,control:Y,errors:_,readOnly:!0}),!l&&e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"mb-2 block font-medium text-gray-700 dark:text-dark-50",children:"Enter Quantity"}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsx("input",{type:"number",className:"form-input w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm+ dark:border-dark-500",placeholder:"Enter quantity",onChange:t=>{const s=parseFloat(t.target.value)||0,r=O("items")||[];if(r.length>0){const w=r.map(g=>{const a=g.custom_cumulative_qty||0,m=a+s;return{...g,qty:s,custom_produced_qty:a,custom_cumulative_qty:m,custom_serial_count:(g.custom_serial_count||0)+1}});C("items",w)}}})})]})]})})})}),(l||O("custom_site"))&&e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-4 lg:space-y-6",children:e.jsx(ie,{className:"space-y-5 p-4 sm:px-5",children:e.jsx(X,{infos:i,fields:pe,tables:fe,register:y,control:Y,errors:_,readOnly:(i==null?void 0:i.is_submittable)&&(v==null?void 0:v.docstatus)})})})]})})]}),O("customer")&&e.jsx(Ee,{isOpen:M,onClose:()=>J(!1),onSelect:_e,customer:O("customer")})]})}export{st as default};
