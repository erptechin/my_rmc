import{u as q,e as z,n as L,I as T,a as n,j as e,S as V,B as d,C as N,J as v}from"./index-f3r6umgb.js";import{u as W,o as G,a as H,C as K}from"./index.esm-BMFR-kb1.js";import{S as M,D as Q,a as X}from"./SearchSelect-DAgorlIL.js";import{P as Y}from"./Page-CZhRYwf3.js";import{a as Z,c as ee,u as se,d as te}from"./useApiHook-CZnV53As.js";import{F as ie}from"./DocumentPlusIcon-y-FpWJLf.js";import"./combobox-BXRS2Luv.js";import"./transition-Cc3pRxfh.js";import"./floating-ui.dom-CtcSe9Ld.js";import"./frozen-CEV0bN27.js";import"./active-element-history-HeLJeWOz.js";import"./Datepicker-Ma-0Q657.js";import"./popover-BlpAwzgS.js";import"./index-CM3VLHP_.js";import"./iconBase-GIGs6mnI.js";import"./ConfirmModal-MqYg-eza.js";import"./XMarkIcon-Xa9uEXuI.js";import"./useUnmount-BWDo5Kza.js";import"./useMutation-BJYoKC_t.js";const w="Sales Order List",m="Sales Order",C=["customer","delivery_date","po_no","po_date","items"],ae=["custom_site"],re={items:{item_code:!0,qty:!0,conversion_factor:!0},ignorFields:{custom_site:!0}};function we(){var j;const{isDark:F,darkColorScheme:k,lightColorScheme:E}=q(),{user:u}=z(),O=(j=u==null?void 0:u.settings)!=null&&j.is_enable_branch?["custom_branch"]:[],p=L(),{id:r}=T(),[g,A]=n.useState(null),[I,J]=n.useState({}),[$,f]=n.useState([]),{data:s,isFetching:B}=Z({doctype:m,fields:JSON.stringify([...O,...C,...ae])}),{data:t,isFetching:D}=ee({doctype:m,id:r,fields:g?JSON.stringify(g):null});n.useEffect(()=>{if(s!=null&&s.fields){let i=s==null?void 0:s.fields.map(a=>a.fieldname);A(i),J(Object.fromEntries(i.map(a=>[a,""])))}},[s==null?void 0:s.fields]);const{register:y,handleSubmit:P,formState:{errors:S},control:h,reset:b,setValue:o}=W({resolver:G(M(s==null?void 0:s.fields)),values:r?t:I}),x=H({control:h,name:"customer"});n.useEffect(()=>{(async()=>{if(x)try{const a=await v({url:`my_rmc.api.custom.get_customer_address?customer_name=${x}`});if(a){const c=a.map(l=>({label:l.site_name||l.name,value:l.name}));f(c),c.length===1?o("custom_site",c[0].value):c.length===0&&o("custom_site","")}}catch(a){console.error("Error fetching customer sites:",a),f([]),o("custom_site","")}else f([]),o("custom_site","")})()},[x,o]);const R=se(i=>{i&&(b(),p(-1))}),_=te(i=>{i&&(b(),p(-1))}),U=async i=>{r?(t==null?void 0:t.docstatus)===1?(await v({url:`my_rmc.api.doctype.update_data?doctype=${m}&name=${r}&update_fields=${JSON.stringify([{docstatus:0}])}`})).success&&(delete i.creation,delete i.modified,_.mutate({doctype:m,body:{...i,docstatus:1,id:r}})):_.mutate({doctype:m,body:{...i,id:r}}):R.mutate({doctype:m,body:i})};return B||D?e.jsx(V,{style:{"--sk-color":F?k[700]:E[300]}}):e.jsx(Y,{title:(r?"Edit ":"New ")+w,children:e.jsxs("div",{className:"transition-content px-(--margin-x) pb-6",children:[e.jsxs("div",{className:"flex flex-col items-center justify-between space-y-4 py-5 sm:flex-row sm:space-y-0 lg:py-6",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ie,{className:"size-6"}),e.jsxs("h2",{className:"line-clamp-1 text-xl font-medium text-gray-700 dark:text-dark-50",children:[r?"Edit":"New"," ",w]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d,{className:"min-w-[7rem]",variant:"outlined",color:"error",onClick:()=>p(-1),children:"Back"}),s!=null&&s.is_submittable?e.jsxs(e.Fragment,{children:[e.jsx(d,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",disabled:(t==null?void 0:t.docstatus)>1,onClick:()=>o("docstatus",0),children:"Save"}),(t==null?void 0:t.docstatus)===1?e.jsx(d,{className:"min-w-[7rem]",color:"error",type:"submit",form:"new-post-form",onClick:()=>o("docstatus",2),children:"Cancel"}):e.jsx(d,{className:"min-w-[7rem]",color:"success",type:"submit",form:"new-post-form",disabled:(t==null?void 0:t.docstatus)>1,onClick:()=>o("docstatus",1),children:"Submit"})]}):e.jsx(d,{className:"min-w-[7rem]",color:"primary",type:"submit",form:"new-post-form",children:"Save"})]})]}),e.jsx("form",{autoComplete:"off",onSubmit:P(U),id:"new-post-form",children:e.jsxs("div",{className:"grid grid-cols-12 place-content-start gap-4 sm:gap-5 lg:gap-6",children:[e.jsx("div",{className:"col-span-12 lg:col-span-8",children:e.jsx(N,{className:"p-4 sm:px-5",children:e.jsx("div",{className:"mt-5 space-y-5",children:e.jsx(Q,{infos:s,fields:C,tables:re,register:y,control:h,errors:S,readOnly:(s==null?void 0:s.is_submittable)&&(t==null?void 0:t.docstatus)})})})}),e.jsx("div",{className:"col-span-12 space-y-4 sm:space-y-5 lg:col-span-4 lg:space-y-6",children:e.jsx(N,{className:"space-y-5 p-4 sm:px-5",children:e.jsx(K,{render:({field:{onChange:i,value:a,...c}})=>{var l;return e.jsx(X,{onChange:i,value:a,label:"Site",lists:$,placeholder:"Select Site",error:(l=S.custom_site)==null?void 0:l.message,readOnly:(s==null?void 0:s.is_submittable)&&(t==null?void 0:t.docstatus),...c})},control:h,name:"custom_site",...y("custom_site")})})})]})})]})})}export{we as default};
